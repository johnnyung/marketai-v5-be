datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

// 1. UNIVERSE & REFERENCE
model Ticker {
  id           String   @id @default(cuid())
  symbol       String   @unique
  name         String?
  exchange     String?
  sector       String?
  industry     String?
  assetClass   String   @default("stock")
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  fundamentals     Fundamentals[]
  prices           PriceHistory[]
  metrics          KeyMetrics[]
  insider          InsiderTransaction[]
  news             NewsItem[]
  institutional    InstitutionalOwnership[]
  options          OptionsFlow[]
  analysisBundles  IntelligenceBundle[]
  opportunities    Opportunity[]
  macroData        MacroDatum[]
  
  @@index([sector])
}

// 2. DATA INGESTION MODELS
model Fundamentals {
  id           String   @id @default(cuid())
  tickerId     String
  ticker       Ticker   @relation(fields: [tickerId], references: [id])
  period       String?
  date         DateTime
  revenue      Decimal? @db.Decimal(18, 2)
  netIncome    Decimal? @db.Decimal(18, 2)
  eps          Float?
  totalDebt    Decimal? @db.Decimal(18, 2)
  totalEquity  Decimal? @db.Decimal(18, 2)
  details      Json?
  createdAt    DateTime @default(now())

  @@index([tickerId])
}

model KeyMetrics {
  id           String   @id @default(cuid())
  tickerId     String
  ticker       Ticker   @relation(fields: [tickerId], references: [id])
  date         DateTime
  peRatio      Float?
  details      Json?
  createdAt    DateTime @default(now())

  @@index([tickerId])
}

model PriceHistory {
  id        String   @id @default(cuid())
  tickerId  String
  ticker    Ticker   @relation(fields: [tickerId], references: [id])
  date      DateTime
  open      Float?
  high      Float?
  low       Float?
  close     Float?
  volume    BigInt?
  source    String?
  
  @@unique([tickerId, date])
  @@index([tickerId])
}

model InsiderTransaction {
  id              String   @id @default(cuid())
  tickerId        String
  ticker          Ticker   @relation(fields: [tickerId], references: [id])
  transactionDate DateTime
  insiderName     String?
  transactionType String?
  shares          Float?
  price           Float?
  raw             Json?
  createdAt       DateTime @default(now())

  @@index([tickerId])
}

model NewsItem {
  id          String   @id @default(cuid())
  tickerId    String?
  ticker      Ticker?  @relation(fields: [tickerId], references: [id])
  title       String?
  publisher   String?
  url         String?
  publishedAt DateTime?
  sentiment   Float?
  raw         Json?
  createdAt   DateTime @default(now())

  @@index([tickerId])
}

model InstitutionalOwnership {
  id          String   @id @default(cuid())
  tickerId    String
  ticker      Ticker   @relation(fields: [tickerId], references: [id])
  holder      String?
  shares      Float?
  change      Float?
  date        DateTime?
  raw         Json?
  createdAt   DateTime @default(now())

  @@index([tickerId])
}

model OptionsFlow {
  id          String   @id @default(cuid())
  tickerId    String?
  ticker      Ticker?  @relation(fields: [tickerId], references: [id])
  date        DateTime?
  contract    String?
  putCall     String? // "CALL" | "PUT"
  premium     Float?
  volume      Float?
  openInterest Float?
  raw         Json?
  createdAt   DateTime @default(now())
  
  @@index([tickerId])
}

model MacroDatum {
  id        String   @id @default(cuid())
  category  String
  date      DateTime
  value     Float?
  raw       Json?
  tickerId  String?
  ticker    Ticker? @relation(fields: [tickerId], references: [id])
  createdAt DateTime @default(now())
  
  @@index([category, date])
}

model IngestionLog {
  id           String   @id @default(cuid())
  module       String
  category     String?
  status       String
  itemsFetched Int?
  itemsWritten Int?
  startedAt    DateTime
  endedAt      DateTime?
  error        String?
}

// 3. BRAIN & INTELLIGENCE MODELS (PHASE 8 ENHANCED)
model IntelligenceBundle {
  id             String   @id @default(cuid())
  tickerId       String
  ticker         Ticker   @relation(fields: [tickerId], references: [id])
  runAt          DateTime @default(now())
  
  // Phase 8: Idempotency & Versioning
  runHash        String?  // Deterministic hash (ticker + 15m window)
  engineVersion  String   @default("v5.0.0")

  compositeScore Float?
  riskScore      Float?
  signals        Json?    // Stores Record<string, EngineResult>
  summary        String?  // Trade Plan JSON
  
  // Phase 8: Linkage
  opportunity    Opportunity?

  @@index([tickerId])
  @@unique([tickerId, runHash]) // Prevent duplicate runs
}

model Opportunity {
  id                   String   @id @default(cuid())
  tickerId             String
  ticker               Ticker   @relation(fields: [tickerId], references: [id])
  
  // Phase 8: Linkage
  intelligenceBundleId String?  @unique
  intelligenceBundle   IntelligenceBundle? @relation(fields: [intelligenceBundleId], references: [id])

  score     Float?
  category  String?
  rationale String?
  catalysts Json?       // Explicitly mapped catalyst objects
  createdAt DateTime @default(now())
  
  @@index([tickerId])
}
